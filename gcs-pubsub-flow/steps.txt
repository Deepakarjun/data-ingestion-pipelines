# Set variables

export PROJECT_ID=terraform-test-gcp-0114
export IMAGE_NAME="gcs-stream-flow"
export REPO_NAME="dataflow-flex-repo"
export BUCKET_NAME="test-configurations-0114"
export REGION="us-east1"
export TAG="v4"
export NAME_FLEX_TEMPLATE="gcs-stream-flex-template.json"

# Create Artifact Registry repository (if it doesn't exist)
gcloud artifacts repositories create $REPO_NAME --repository-format=docker --location=$REGION

# Submit the build
gcloud builds submit --tag $REGION-docker.pkg.dev/$PROJECT_ID/$REPO_NAME/$IMAGE_NAME:$TAG .

gcloud dataflow flex-template build gs://$BUCKET_NAME/templates/$NAME_FLEX_TEMPLATE \
  --image=$REGION-docker.pkg.dev/$PROJECT_ID/$REPO_NAME/$IMAGE_NAME:$TAG \
  --sdk-language=PYTHON \
  --metadata-file=metadata.json


gcloud dataflow flex-template run "gcs-stream-$(date +%Y%m%d%H%M%S)" \
  --template-file-gcs-location="gs://$BUCKET_NAME/templates/$NAME_FLEX_TEMPLATE" \
  --region="$REGION" \
  --parameters="^|^input_bucket=gs://$BUCKET_NAME/data|output_topic=projects/$PROJECT_ID/topics/eggress_costco_topic|interval_sec=30|expected_date_yyyymmdd=$(date +%Y%m%d)|required_keys=id,name,timestamp"


docker run -it --entrypoint /bin/bash a2ddf2bd16fc

